# Реализация функциональности Классов (Classes)

## Обзор

Этот документ описывает полную реализацию функциональности для работы с классами D&D 5e из Player's Handbook 2024. Реализация включает:

1. ✅ Схему базы данных Prisma для классов
2. ✅ Бэкенд сервис для работы с классами
3. ✅ API эндпоинты для CRUD операций
4. ✅ Фронтенд компонент для просмотра и редактирования классов
5. ✅ Интеграцию на главную страницу
6. ✅ Скрипты для сидирования данных
7. ✅ Экспорт данных в CSV формат

## Структура проекта

### Backend

```
backend/
├── prisma/
│   └── schema.prisma                    # Обновлённая схема с классами
├── src/
│   ├── controllers/
│   │   └── classController.ts           # Контроллер для классов
│   ├── services/
│   │   └── classService.ts              # Сервисный слой
│   └── routes/
│       └── classes.ts                    # Роуты API
├── generate-classes-csv.ts               # Генератор CSV
├── seed-classes.ts                       # Сидер классов
├── CLASSES_API.md                        # Документация API
└── CLASSES_MIGRATION.md                  # Инструкция по миграции
```

### Frontend

```
src/
├── api/
│   ├── client.ts                         # API клиент (добавлен classesApi)
│   └── hooks.ts                         # React Query hooks
├── components/
│   ├── ClassesPage.tsx                   # Страница классов
│   └── HomePage.tsx                     # Обновлённая главная страница
└── App.tsx                              # Роутинг (добавлен /classes)
```

## Функциональность

### 1. Схема базы данных

#### CharacterClass
Основная таблица для хранения информации о классах:
- Внешний ID для интеграции с фронтендом
- Названия на русском и английском
- Описание класса
- Кость хитов (d6, d8, d10, d12)
- Первичные характеристики
- Спасброски
- Владение доспехами и оружием
- Навыки на выбор
- Уровень получения подкласса
- Источник данных (SRD или PHB 2024)

#### ClassFeature
Черты классов (уровневые способности):
- Названия на русском и английском
- Описание черты
- Уровень получения

#### Subclass
Подклассы:
- Внешний ID
- Названия на русском и английском
- Описание подкласса
- Связь с родительским классом

#### SubclassFeature
Черты подклассов (аналогично чертам классов)

### 2. Backend API

#### Публичные эндпоинты (без аутентификации)

```
GET /api/classes                    - Все классы
GET /api/classes?source=phb2024    - Фильтрация по источнику
GET /api/classes/:id                - Класс по ID
GET /api/classes/external/:externalId - Класс по внешнему ID
```

#### Административные эндпоинты (требуют аутентификацию)

```
POST   /api/classes      - Создать класс
PUT    /api/classes/:id  - Обновить класс
DELETE /api/classes/:id  - Удалить класс
```

### 3. Frontend

#### Страница классов (`/classes`)

**Для всех пользователей:**
- Просмотр списка всех классов
- Разворачивание деталей класса по клику
- Просмотр описания класса
- Просмотр всех черт класса с уровнями
- Просмотр подклассов с их чертами

**Для мастеров (role === "master"):**
- Создание новых классов
- Редактирование существующих классов
- Удаление классов
- Управление чертами классов

### 4. CSV Экспорт

Скрипт генерирует CSV файл с основными данными классов для ручного импорта в другие системы:

```bash
npm run generate:classes:csv
```

**Включённые поля:**
- Внешний ID
- Названия (русский и английский)
- Описание
- Кость хитов
- Первичные характеристики
- Спасброски
- Владение доспехами и оружием
- Навыки на выбор
- Уровень получения подкласса
- Источник

**Примечание:** Черты и подклассы не включены в CSV из-за сложной вложенной структуры. Для полной миграции используйте скрипт сидирования.

### 5. Сидирование данных

```bash
npm run seed:classes
```

Импортирует все 12 классов из PHB 2024:
1. Barbarian (Варвар)
2. Bard (Бард)
3. Cleric (Жрец)
4. Druid (Друид)
5. Fighter (Воин)
6. Monk (Монах)
7. Paladin (Паладин)
8. Ranger (Следопыт)
9. Rogue (Плут)
10. Sorcerer (Чародей)
11. Warlock (Колдун)
12. Wizard (Волшебник)

## Установка и настройка

### 1. Применение миграции

```bash
cd backend

# Локальная разработка
npx prisma migrate dev --name add_classes_table

# Продакшен
npx prisma migrate deploy

# Генерация Prisma Client
npx prisma generate
```

### 2. Сидирование данных

```bash
cd backend
npm run seed:classes
```

### 3. Проверка работоспособности

#### Бэкенд
```bash
cd backend
npm run dev
```

Проверить API:
```bash
curl http://localhost:3001/api/classes
```

#### Фронтенд
```bash
npm run dev
```

Перейти на `http://localhost:5173/classes`

## Использование

### Просмотр классов

1. На главной странице нажмите "Классы PHB 2024"
2. Откроется страница со списком всех классов
3. Кликните на любой класс для просмотра деталей
4. В развернутом виде видно:
   - Описание класса
   - Все черты с уровнями
   - Все подклассы с их чертами

### Редактирование классов (для мастеров)

1. Откройте страницу классов
2. Кликните на класс для редактирования
3. Нажмите на иконку карандаша
4. Внесите изменения в модальном окне
5. Нажмите "Сохранить"

### Создание нового класса (для мастеров)

1. На странице классов нажмите "Создать класс"
2. Заполните обязательные поля:
   - Внешний ID (например, "paladin")
   - Название (русский)
   - Название (английский)
   - Описание
   - Кость хитов
   - Первичные характеристики
   - Спасброски
3. Добавьте черты класса
4. Нажмите "Создать"

## Технические детали

### Типы данных

Frontend использует интерфейс `CharacterClass` из `src/types/character.ts`:

```typescript
interface CharacterClass {
  id: string;
  name: string;
  nameRu: string;
  description: string;
  hitDie: number;
  primaryAbility: AbilityName[];
  savingThrows: AbilityName[];
  armorProficiencies: string[];
  weaponProficiencies: string[];
  skillChoices: string[];
  skillCount: number;
  features: ClassFeature[];
  subclasses: Subclass[];
  subclassLevel: number;
  source: "srd" | "phb2024";
}
```

### Хранение в базе данных

Массивы хранятся как JSON строки:
- `primaryAbility`: `["strength", "constitution"]` → `"[\"strength\", \"constitution\"]"`
- `savingThrows`: `["strength", "constitution"]` → `"[\"strength\", \"constitution\"]"`
- `armorProficiencies`: `["Лёгкие доспехи", "Щиты"]` → `"[\"Лёгкие доспехи\", \"Щиты\"]"`

При получении из БД они автоматически парсятся сервисным слоем.

### Валидация

Бэкенд использует Zod для валидации входных данных:

```typescript
const createClassSchema = z.object({
  externalId: z.string().min(1),
  name: z.string().min(1),
  nameRu: z.string().min(1),
  description: z.string().min(1),
  hitDie: z.number().int().positive(),
  primaryAbility: z.array(z.string()).min(1),
  savingThrows: z.array(z.string()).min(1),
  features: z.array(createClassFeatureSchema).min(1),
  // ...
});
```

### React Query

Фронтенд использует TanStack Query для кэширования и управления состоянием:

```typescript
// Получение списка классов
const { data, isLoading, error, refetch } = useBackendClasses('phb2024');

// Получение одного класса
const { data: classData } = useBackendClass(classId);

// Мутации
const createMutation = useMutation({
  mutationFn: (data) => classesApi.create(data),
  onSuccess: () => refetch(),
});
```

## Документация

- **API документация**: `backend/CLASSES_API.md`
- **Миграция и сидирование**: `backend/CLASSES_MIGRATION.md`
- **Данные классов**: `src/data/phb2024/classes.ts`

## Будущие улучшения

Возможные улучшения для будущих версий:

1. **Фильтрация и поиск**
   - Поиск по названию
   - Фильтрация по кости хитов
   - Фильтрация по первичным характеристикам

2. **Сравнение классов**
   - Возможность сравнить два класса
   - Визуализация различий

3. **Более детальное редактирование подклассов**
   - Полный CRUD для подклассов
   - Редактирование черт подклассов

4. **Экспорт/импорт**
   - Экспорт отдельных классов в JSON
   - Импорт классов из JSON

5. **Иконки классов**
   - Уникальные иконки для каждого класса
   - Визуальные различия

## Поддержка

При возникновении проблем:

1. Проверьте, что миграция применена
2. Убедитесь, что данные сидированы
3. Проверьте логи бэкенда и фронтенда
4. Убедитесь, что API URL в `.env` корректный
5. Проверьте CORS настройки

Дополнительная информация в документации:
- `backend/CLASSES_API.md`
- `backend/CLASSES_MIGRATION.md`
