// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String?
  role      String   @default("player") // "player" or "master"
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  characters          Character[]
  roomsMastered       Room[]              @relation("RoomMaster")
  roomsJoined         RoomPlayer[]
  achievements        PlayerAchievement[] @relation("PlayerAchievements")
  achievementsGranted PlayerAchievement[] @relation("GrantedAchievements")
}

model Race {
  id               String   @id @default(uuid())
  externalId       String   @unique
  name             String
  nameRu           String
  description      Json     // Changed to Json for rich text
  speed            String   // Changed to String as it contains text like "30 футов"
  size             String
  abilityIncreases Json?
  source           Json     // Changed to Json for structured source info
  image            String?
  gallery          String[]
  hasLineages      Boolean  @default(false)
  lastUsername     String?
  properties       Json?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  traits RaceTrait[]
}

model RaceTrait {
  id          String   @id @default(uuid())
  raceId      String
  externalId  String?
  name        String
  nameRu      String
  description Json     // Changed to Json for rich text
  createdAt   DateTime @default(now())

  race Race @relation(fields: [raceId], references: [id], onDelete: Cascade)

  @@index([raceId])
}


model Character {
  id        String   @id @default(uuid())
  userId    String
  name      String
  data      Json // The large blob used by characterService
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  achievements PlayerAchievement[]
  roomsJoined  RoomPlayer[]

  @@index([userId])
}

model CharacterClass {
  id                  String   @id @default(uuid())
  externalId          String   @unique // ID from the frontend (e.g., "barbarian", "wizard")
  name                String
  nameRu              String
  description         Json? // Changed from String to Json to store rich text array
  image               String? // Main image
  gallery             String[] // Additional images
  hitDie              Int
  primaryAbility      String[]
  savingThrows        String[]
  armorProficiencies  String[]
  weaponProficiencies String[]
  skillChoices        String[]
  skillCount          Int
  subclassLevel       Int
  source              String // "srd" or "phb2024"
  spellcasting        Json? // Spellcasting data: { ability, cantripsKnown, spellsKnown, spellSlots }
  classTable          Json? // Full table data from JSON
  multiclassing       Json? // Multiclassing rules
  startingGold        Int      @default(0) // Starting gold amount
  startingEquipment   Json? // Rich equipment data from PHB 2024
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  features   ClassFeature[]
  subclasses Subclass[]

  @@index([externalId])
  @@index([source])
}

model ClassFeature {
  id          String   @id @default(uuid())
  classId     String
  name        String
  nameRu      String
  description Json? // Changed to Json for rich text
  level       Int
  createdAt   DateTime @default(now())

  class CharacterClass @relation(fields: [classId], references: [id], onDelete: Cascade)

  @@index([classId])
}

model Subclass {
  id          String   @id @default(uuid())
  classId     String
  externalId  String // ID from frontend
  name        String
  nameRu      String
  description Json? // Changed to Json for rich text
  source      String   @default("phb2024")
  createdAt   DateTime @default(now())

  class      CharacterClass    @relation(fields: [classId], references: [id], onDelete: Cascade)
  features   SubclassFeature[]
  classTable Json? // Subclass specific table overrides if any

  @@index([classId])
  @@index([externalId])
}

model SubclassFeature {
  id          String   @id @default(uuid())
  subclassId  String
  name        String
  nameRu      String
  description Json? // Changed to Json for rich text
  level       Int
  createdAt   DateTime @default(now())

  subclass Subclass @relation(fields: [subclassId], references: [id], onDelete: Cascade)

  @@index([subclassId])
}

model Equipment {
  id          String   @id @default(uuid())
  externalId  String   @unique
  name        String
  nameRu      String
  category    String
  cost        Json // { quantity: number, unit: string }
  weight      Float?
  source      String
  description Json?
  damage      Json? // { dice: string, type: string }
  armorClass  Int?
  armorType   String?
  maxDexBonus Int?
  properties  String[] @default([])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  backgroundEquipment BackgroundEquipment[]
}

model Background {
  id                   String   @id @default(uuid())
  externalId           String   @unique // ID from the frontend (e.g., "acolyte", "artisan")
  name                 String
  nameRu               String
  description          String   @db.Text
  skillProficiencies   String[] // Array of skill IDs
  toolProficiencies    String[] // Array of tool names
  languages            Int // Number of additional languages
  startingGold         Int
  originFeat           String
  abilityScoreIncrease Json // { options: string[], amount: number[] }
  source               String // "phb2024", etc.
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  equipment BackgroundEquipment[]

  @@index([externalId])
  @@index([source])
}

model BackgroundEquipment {
  id           String @id @default(uuid())
  backgroundId String
  itemId       String
  quantity     Int    @default(1)

  background Background @relation(fields: [backgroundId], references: [id], onDelete: Cascade)
  equipment  Equipment  @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@index([backgroundId])
  @@index([itemId])
}

model Spell {
  id          String   @id @default(uuid())
  externalId  String   @unique // ID from the frontend (e.g., "fire-bolt", "magic-missile")
  name        String
  nameRu      String
  level       Int // 0 for cantrips, 1-9 for spell levels
  school      String // School of magic (e.g., "Воплощение", "Вызов")
  castingTime String
  range       String
  components  String
  duration    String
  description Json // Array of description paragraphs (can include strings and table objects)
  classes     String[] // Array of class IDs that can use this spell
  source      String   @default("phb2024")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([externalId])
  @@index([level])
  @@index([source])
}

model Achievement {
  id          String   @id @default(uuid())
  key         String   @unique
  name        String
  description String
  icon        String
  category    String
  rarity      String
  xpReward    Int      @default(0)
  createdAt   DateTime @default(now())

  playerAchievements PlayerAchievement[]
}

model PlayerAchievement {
  id            String   @id @default(uuid())
  achievementId String
  userId        String
  characterId   String?
  grantedById   String
  grantedAt     DateTime @default(now())

  achievement Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)
  user        User        @relation("PlayerAchievements", fields: [userId], references: [id], onDelete: Cascade)
  character   Character?  @relation(fields: [characterId], references: [id], onDelete: SetNull)
  grantedBy   User        @relation("GrantedAchievements", fields: [grantedById], references: [id], onDelete: Cascade)

  @@index([achievementId])
  @@index([userId])
  @@index([characterId])
}

model Room {
  id         String   @id @default(uuid())
  masterId   String
  name       String
  maxPlayers Int      @default(4)
  password   String
  isActive   Boolean  @default(true)
  isStarted  Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  master  User         @relation("RoomMaster", fields: [masterId], references: [id], onDelete: Cascade)
  players RoomPlayer[]
}

model RoomPlayer {
  id          String   @id @default(uuid())
  roomId      String
  userId      String
  characterId String
  joinedAt    DateTime @default(now())
  isOnline    Boolean  @default(true)

  room      Room      @relation(fields: [roomId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  character Character @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@unique([roomId, userId], name: "roomId_userId")
  @@index([roomId])
  @@index([userId])
  @@index([characterId])
}

model GlossaryTerm {
  id          String   @id
  name        String
  nameRu      String
  category    String
  description Json
  source      String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([category])
  @@index([name])
  @@index([nameRu])
}

model Feat {
  id           String   @id
  name         String
  nameRu       String
  category     String
  prerequisite String?
  description  Json
  source       String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([category])
  @@index([name])
  @@index([nameRu])
}
